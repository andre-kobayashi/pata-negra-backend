generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */
enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

/**
 * üî• PRODUTOS
 */
enum ProductKind {
  SIMPLE
  CONFIGURABLE
  BUNDLE
}

enum PriceType {
  FIXED
  DYNAMIC
}

enum AttributeInputType {
  RADIO
  SELECT
  CHECKBOX
  MULTISELECT
}

enum PriceModifierType {
  NONE
  FIXED
  PER_KG
  PERCENT
}

/**
 * üî• CAMPANHAS
 */
enum CampaignType {
  WEEKLY
  DATE_RANGE
}

/**
 * üî• LOG√çSTICA
 */
enum StorageType {
  SECO
  REFRIGERADO
  CONGELADO
}

/**
 * =========================
 * USERS & ADDRESS
 * =========================
 */
model User {
  id       String  @id @default(uuid())
  name     String
  email    String  @unique
  password String
  role     Role    @default(CUSTOMER)
  active   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses Address[]
  orders    Order[]
}

model Address {
  id         String  @id @default(uuid())
  userId     String
  postalCode String
  prefecture String
  city       String
  address1   String
  address2   String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
}

/**
 * =========================
 * CATEGORIES
 * =========================
 */
model Category {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  image       String?

  seoTitle       String?
  seoDescription String?

  parentId String?
  active   Boolean @default(true)
  sort     Int     @default(0)

  onlineMarkupActive  Boolean @default(false)
  onlineMarkupPercent Float   @default(12.0)

  parent   Category?         @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[]        @relation("CategoryTree")
  products ProductCategory[]

  /**
   * üî• CAMPANHAS
   */
  campaigns Campaign[] @relation("CategoryCampaigns")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([active, sort])
}

/**
 * =========================
 * üî• CAMPANHAS
 * =========================
 */
model Campaign {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  active      Boolean @default(true)

  type CampaignType @default(WEEKLY)

  dayOfWeek Int?
  startDate DateTime?
  endDate   DateTime?

  bannerDesktop String?
  bannerMobile  String?
  themeColor    String?

  /**
   * üî• RELA√á√ïES
   */
  products   Product[]  @relation("ProductCampaigns")
  categories Category[] @relation("CategoryCampaigns")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, type])
  @@index([dayOfWeek])
}

/**
 * =========================
 * PRODUCTS
 * =========================
 */
model Product {
  id          String  @id @default(uuid())
  name        String
  sku         String? @unique
  description String? @db.Text

  kind      ProductKind @default(SIMPLE)
  priceType PriceType   @default(FIXED)

  active Boolean @default(true)

  image          String?
  seoTitle       String?
  seoDescription String?

  storageType StorageType @default(SECO)

  costPrice   Int?
  priceRetail Int?
  priceOnline Int?
  promoPrice  Int?

  priceFixed Int?

  basePricePerKg Int?
  baseWeightKg   Float? @default(1.0)
  weightFixedKg  Float?
  minWeightKg    Float?
  maxWeightKg    Float?

  basePrepDays Int? @default(0)

  /**
   * üî• CAMPANHAS
   */
  campaigns Campaign[] @relation("ProductCampaigns")

  categories ProductCategory[]
  attributes ProductAttributeGroup[]
  stock      Stock?
  orderItems OrderItem[]

  bundleItems   ProductBundleItem[] @relation("BundleToItems")
  parentBundles ProductBundleItem[] @relation("ItemInBundle")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, kind])
}

/**
 * =========================
 * BUNDLE ASSOCIATIVA
 * =========================
 */
model ProductBundleItem {
  id        String @id @default(uuid())
  bundleId  String
  productId String
  quantity  Float  @default(1.0)

  bundle  Product @relation("BundleToItems", fields: [bundleId], references: [id], onDelete: Cascade)
  product Product @relation("ItemInBundle", fields: [productId], references: [id], onDelete: Cascade)

  @@unique([bundleId, productId])
}

/**
 * =========================
 * RELA√á√ïES
 * =========================
 */
model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
}

/**
 * =========================
 * ATTRIBUTES
 * =========================
 */
model AttributeGroup {
  id        String             @id @default(uuid())
  name      String
  code      String             @unique
  inputType AttributeInputType
  required  Boolean            @default(false)
  sort      Int                @default(0)

  options  AttributeOption[]
  products ProductAttributeGroup[]

  createdAt DateTime @default(now())
}

model AttributeOption {
  id      String  @id @default(uuid())
  groupId String
  label   String
  sku     String?
  sort    Int     @default(0)

  priceModifierType  PriceModifierType @default(NONE)
  priceModifierValue Float?

  weightMultiplier Float?
  weightDeltaKg    Float?
  weightOverrideKg Float?

  extraPrepDays Int?  @default(0)
  yieldRules    Json?

  group AttributeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId, sort])
}

model ProductAttributeGroup {
  id        String @id @default(uuid())
  productId String
  groupId   String
  stepOrder Int    @default(0)

  requiredOverride Boolean?
  condition        Json?

  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  group   AttributeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([productId, groupId])
}

/**
 * =========================
 * STOCK & ORDERS
 * =========================
 */
model Stock {
  id        String @id @default(uuid())
  productId String @unique
  quantity  Float  @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id     String      @id @default(uuid())
  userId String
  status OrderStatus @default(PENDING)
  total  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  items   OrderItem[]
  payment Payment?

  @@index([userId, createdAt])
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String
  quantity  Int

  productName    String
  productSku     String?
  basePricePerKg Int?
  baseWeightKg   Float?
  finalWeightKg  Float?
  unitPrice      Int
  total          Int
  extraPrepDays  Int?    @default(0)

  order      Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product              @relation(fields: [productId], references: [id])
  selections OrderItemSelection[]

  createdAt DateTime @default(now())
}

model OrderItemSelection {
  id          String  @id @default(uuid())
  orderItemId String
  groupId     String?
  optionId    String?

  groupCode   String?
  groupName   String?
  optionLabel String?

  priceImpact    Float?
  weightImpactKg Float?
  extraPrepDays  Int?

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
}

model Payment {
  id      String        @id @default(uuid())
  orderId String        @unique
  method  String
  status  PaymentStatus @default(PENDING)
  amount  Int

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}
